import React from 'react';
import { _cs, mean, sum } from '@togglecorp/fujs';
import { extent } from 'd3-array';
import { MapboxGeoJSONFeature } from 'mapbox-gl';

import modalize from '#rscg/Modalize';

import {
    createRequestClient,
    NewProps,
    ClientAttributes,
    methods,
} from '#request';

import MapShapeEditor from '#re-map/MapShapeEditor';
import { MapChildContext } from '#re-map/context';
import AccentButton from '#rsca/Button/AccentButton';
import Loading from '#components/Loading';
import LayerSelection from '#components/LayerSelection';

import { MultiResponse } from '#store/atom/response/types';
import {
    VulnerabilityItem,
    LayerHierarchy,
} from '#types';
import { Draw } from '#re-map/type';

import { generatePaint } from '#utils/domain';

import VulnerabilityVisualizations from './Visualizations';
import vulnerabilityTypes, { flatVulnerabilityTypes } from './vulnerabilityTypes';
import { Municipality } from '#store/atom/page/types';
import { getResults, isAnyRequestPending } from '#utils/request';

import Summary from './Summary';
import styles from './styles.scss';

const VisualizationButton = modalize(AccentButton);
const SummaryButton = modalize(AccentButton);

interface OwnProps {
    className: string;
}

interface State {
    vulnerability: VulnerabilityItem[];
    selectedIndicator: string | undefined;
    selectedFeatures: MapboxGeoJSONFeature[] | undefined;
    layers: LayerHierarchy[];
}

interface Params {
    setVulnerability?: (vulnerability: VulnerabilityItem[], layers: LayerHierarchy[]) => void;
    coordinates?: [number, number][];
}

type Props = NewProps<OwnProps, Params>;

const colorGrade = [
    '#c73c32',
    '#d98452',
    '#e9bf8c',
    '#fff5d8',
    '#d3dba0',
    '#94c475',
    '#31ad5c',
];

const VulnerabilityTooltipOutput = ({ label, value }) => (
    <div className={styles.vulnerabilityTooltipOutput}>
        <div className={styles.label}>
            { label }
        </div>
        <div className={styles.value}>
            { value }
        </div>
    </div>
);


const VulnerabilityTooltip = ({ feature, layer }) => (
    <div className={styles.vulnerabilityTooltip}>
        <h3 className={styles.heading}>
            { feature.properties.title }
        </h3>
        <div className={styles.content}>
            <VulnerabilityTooltipOutput
                label={layer.layername}
                value={feature.state.value}
            />
        </div>
    </div>
);

const transformVulnerabilityToLayer = (vulnerability, data) => {
    const colors = vulnerability.indicatorType === 'negative' ? [...colorGrade].reverse() : [...colorGrade];

    const mapState = data.map(d => ({
        id: d.municipality,
        value: d.data[vulnerability.id],
    }));

    const [min, max] = extent(mapState, d => d.value);
    const { paint, legend } = generatePaint(colors, min, max);

    return {
        ...vulnerability,
        type: 'choropleth',
        adminLevel: 'municipality',
        layername: vulnerability.title,
        opacity: 1,
        mapState,
        paint,
        legend,
        tooltipRenderer: VulnerabilityTooltip,
    };
};

const createChoroplethLayer = (data) => {
    const layers = vulnerabilityTypes.map((vulnerability) => {
        const layer = transformVulnerabilityToLayer(vulnerability, data);

        if (vulnerability.children.length > 0) {
            layer.children = vulnerability.children.map(
                vc => transformVulnerabilityToLayer(vc, data),
            );
        }

        return layer;
    });

    return layers;
};

const requestOptions: { [key: string]: ClientAttributes<OwnProps, Params>} = {
    vulnerabilityGetRequest: {
        url: '/vulnerability/',
        method: methods.GET,
        onMount: true,
        onSuccess: ({
            response,
            params: { setVulnerability } = { setVulnerability: undefined },
        }) => {
            const { results } = response as MultiResponse<VulnerabilityItem>;
            if (setVulnerability) {
                const layers = createChoroplethLayer(results);
                setVulnerability(results, layers);
            }
        },
    },
    polygonMunicipalityGetRequest: {
        url: '/municipality/',
        method: methods.GET,
        onMount: false,
        query: ({ params }) => {
            if (!params || !params.coordinates) {
                return undefined;
            }

            return {
                // eslint-disable-next-line @typescript-eslint/camelcase
                boundary__within: JSON.stringify({
                    type: 'Polygon',
                    coordinates: params.coordinates,
                }),
            };
        },
    },
};

class Vulnerability extends React.PureComponent<Props, State> {
    public constructor(props: Props) {
        super(props);

        this.state = {
            vulnerability: [],
            selectedIndicator: undefined,
            selectedFeatures: undefined,
            layers: [],
        };

        const {
            requests: {
                vulnerabilityGetRequest,
            },
        } = this.props;

        vulnerabilityGetRequest.setDefaultParams({
            setVulnerability: (data: VulnerabilityItem[], layers: LayerHierarchy[]) => {
                this.setState({
                    vulnerability: data,
                    layers,
                });
            },
        });
    }

    private getSummaryData = (
        vulnerability: VulnerabilityItem[],
        municipalities: Municipality[],
    ) => {
        if (municipalities.length === 0) {
            return flatVulnerabilityTypes.map((f) => {
                const values = vulnerability.map(v => v.data[f.id] || 0);
                if (f.valueType === 'index') {
                    return ({
                        ...f,
                        value: mean(values),
                    });
                }
                return ({
                    ...f,
                    value: sum(values),
                });
            });
        }

        return flatVulnerabilityTypes.map((f) => {
            const values = vulnerability
                .filter(v => municipalities.some(m => m.id === v.municipality))
                .map(v => v.data[f.id] || 0);

            if (f.valueType === 'index') {
                return ({
                    ...f,
                    value: mean(values),
                });
            }
            return ({
                ...f,
                value: sum(values),
            });
        });
    }

    private handlePolygonCreate = (features: MapboxGeoJSONFeature[], draw: Draw | undefined) => {
        const {
            requests: {
                polygonMunicipalityGetRequest,
            },
        } = this.props;
        const { selectedFeatures } = this.state;

        if (selectedFeatures && selectedFeatures[0].id && draw) {
            draw.delete(selectedFeatures[0].id);
        }

        polygonMunicipalityGetRequest.do({
            coordinates: features[0].geometry.coordinates,
        });

        this.setState({
            selectedFeatures: features,
        });
    }

    private handlePolygonUpdate = (features: MapboxGeoJSONFeature[], draw: Draw | undefined) => {
        const {
            requests: {
                polygonMunicipalityGetRequest,
            },
        } = this.props;
        const { selectedFeatures } = this.state;

        if (selectedFeatures && selectedFeatures[0].id && draw) {
            draw.delete(selectedFeatures[0].id);
        }

        polygonMunicipalityGetRequest.do({
            coordinates: features[0].geometry.coordinates,
        });

        this.setState({
            selectedFeatures: features,
        });
    }

    private handlePolygonDelete = (_: MapboxGeoJSONFeature[]) => {
        this.setState({
            selectedFeatures: undefined,
        });
    }

    public render() {
        const {
            className,
            requests,
        } = this.props;

        const {
            vulnerability,
            selectedIndicator,
            layers,
            selectedFeatures,
        } = this.state;


        let selectedMunicipalities = getResults(
            requests,
            'polygonMunicipalityGetRequest',
            [],
        ) as Municipality[];

        if (!selectedFeatures) {
            selectedMunicipalities = [];
        }

        const {
            vulnerabilityGetRequest: {
                pending,
            },
            polygonMunicipalityGetRequest: {
                pending: municipalityPending,
            },
        } = requests;
        const summaryData = this.getSummaryData(vulnerability, selectedMunicipalities);

        return (
            <div className={_cs(styles.vulnerability, className)}>
                <Loading pending={pending} />
                <header className={styles.header}>
                    <h2 className={styles.heading}>
                        Layers
                    </h2>
                    <VisualizationButton
                        transparent
                        className={styles.visualizationButton}
                        disabled={pending}
                        modal={(
                            <VulnerabilityVisualizations
                                data={vulnerability}
                                selectedIndicator={selectedIndicator}
                            />
                        )}
                    >
                        Show visualizations
                    </VisualizationButton>
                    <SummaryButton
                        transparent
                        className={styles.summaryButton}
                        disabled={municipalityPending}
                        modal={(
                            <Summary
                                data={summaryData}
                                municipalities={selectedMunicipalities}
                            />
                        )}
                    >
                        Show summary
                    </SummaryButton>
                </header>
                <LayerSelection
                    className={styles.content}
                    layerList={layers}
                    pending={pending}
                />
                <MapShapeEditor
                    geoJsons={selectedFeatures}
                    onCreate={this.handlePolygonCreate}
                    onUpdate={this.handlePolygonUpdate}
                    onDelete={this.handlePolygonDelete}
                    drawOptions={{
                        displayControlsDefault: false,
                        controls: {
                            polygon: true,
                            trash: true,
                        },
                    }}
                />
            </div>
        );
    }
}

Vulnerability.contextType = MapChildContext;
export default createRequestClient(requestOptions)(Vulnerability);
