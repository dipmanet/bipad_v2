import React from 'react';
import memoize from 'memoize-one';
import { extent } from 'd3-array';
import { isNotDefined } from '@togglecorp/fujs';
import { generateLegendData } from '#utils/domain';

import {
    VulnerabilityType,
    VulnerabilityItem,
    MapState,
    LegendItem,
} from '#types';
import Legend from '#rscz/Legend';
import ChoroplethMap from '#components/ChoroplethMap';

import { flatVulnerabilityTypes } from '../vulnerabilityTypes';
import styles from './styles.scss';

interface Props {
    vulnerabilityIndicator: string | undefined;
    vulnerabilityData: VulnerabilityItem[];
    selectedType: VulnerabilityType | undefined;
}

interface State {
}

interface TooltipParams {
    feature: unknown;
    indicator: VulnerabilityType;
}

const colorGrade = [
    '#cc3535',
    '#da6237',
    '#e38841',
    '#ebac55',
    '#f0ce72',
    '#ccc95e',
    '#a3c352',
    '#72bd50',
    '#24b557',
];

const keySelector = (d: LegendItem) => d.label;
const labelSelector = (d: LegendItem) => d.label;
const colorSelector = (d: LegendItem) => d.color;

const Tooltip = ({ feature, indicator }: TooltipParams) => {
    const { properties: { title }, state: { value } } = feature;

    if (indicator) {
        const valueText = `${indicator.label} : ${value || 'Data Not Available'}`;

        return (
            <div className={styles.tooltip}>
                <div className={styles.title}>{title}</div>
                <div className={styles.value}>{valueText}</div>
            </div>
        );
    }

    return (
        <div className={styles.tooltip}>
            <div className={styles.title}>{title}</div>
        </div>
    );
};

export default class VulnerabilityMap extends React.PureComponent<Props, State> {
    private generateMapState = (
        vulnerability: VulnerabilityItem[],
        indicator: string | undefined,
    ) => {
        const value = vulnerability.map(item => ({
            id: item.municipality,
            value: indicator ? item.data[indicator] : 0,
        }));

        return value;
    };

    private generateColor = memoize(
        (
            maxValue: number,
            minValue: number,
            colorMapping: string[],
            selectedType: VulnerabilityType | undefined,
        ) => {
            let newColorMap = colorMapping;
            if (selectedType && selectedType.indicatorType === 'negative') {
                newColorMap = colorMapping.slice().reverse();
            }

            const newColor: (string | number)[] = [];
            const { length } = newColorMap;
            const range = maxValue - minValue;
            if (isNotDefined(maxValue) || isNotDefined(minValue) || maxValue === minValue) {
                return [];
            }
            const gap = range / (length);
            if (maxValue <= 1) {
                newColorMap.forEach((color, i) => {
                    const val = minValue + (i + 1) * gap;
                    newColor.push(color);
                    newColor.push(val);
                });
            } else {
                newColorMap.forEach((color, i) => {
                    const val = Math.floor(minValue + (i + 1) * gap);
                    newColor.push(color);
                    newColor.push(val);
                });
            }

            return newColor;
        },
    )

    private getLegendData = memoize(generateLegendData);

    private generatePaint = memoize((color: (string | number)[]) => {
        if (color.length <= 0) {
            return {
                'fill-color': 'white',
                'fill-opacity': 0.1,
            };
        }

        const fillColor = [
            'step',
            ['feature-state', 'value'],
            ...color.slice(0, -1),
        ];

        const fillOpacity = [
            'case',
            ['==', ['feature-state', 'value'], null],
            0,
            ['==', ['feature-state', 'hovered'], true],
            0.5,
            1,
        ];

        return ({
            'fill-color': fillColor,
            'fill-opacity': fillOpacity,
        });
    })

    private tooltipParams = () => {
        const { vulnerabilityIndicator: key } = this.props;

        const indicator = flatVulnerabilityTypes.find(v => v.key === key);

        return ({
            indicator,
        });
    }

    public render() {
        const {
            vulnerabilityData,
            vulnerabilityIndicator,
            selectedType,
        } = this.props;

        const mapState = this.generateMapState(vulnerabilityData, vulnerabilityIndicator);

        const [min, max] = extent(mapState, (d: MapState) => d.value);
        const color = this.generateColor(max, min, colorGrade, selectedType);
        const colorPaint = this.generatePaint(color);

        const legendData = this.getLegendData(color);

        return (
            <div className={styles.map}>
                { legendData.length > 0 && (
                    <div className={styles.legendContainer}>
                        <h4 className={styles.heading}>
                            Legend
                        </h4>
                        <Legend
                            className={styles.legend}
                            data={legendData}
                            itemClassName={styles.legendItem}
                            keySelector={keySelector}
                            labelSelector={labelSelector}
                            colorSelector={colorSelector}
                            emptyComponent={null}
                        />
                    </div>
                )}
            </div>
        );
    }
}
